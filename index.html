<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> মেধা যাচাই | Premium Experience</title>
    <style>
        :root {
            --bg: #020617;
            --surface: #0f172a;
            --glass: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.2);
            --success: #10b981;
            --error: #ef4444;
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --radius: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .glass {
            background: var(--glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
        }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate { animation: fadeIn 0.5s ease-out forwards; }

        /* --- LAYOUT --- */
        #app {
            max-width: 1440px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HOME VIEW --- */
        .hero {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
        }

        .hero h1 {
            font-size: clamp(2.5rem, 8vw, 5rem);
            font-weight: 800;
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
        }

        .gradient-text {
            background: linear-gradient(135deg, #fff 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            width: 100%;
            max-width: 900px;
            margin-top: 3rem;
        }

        .portal-card {
            padding: 3rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .portal-card:hover {
            transform: translateY(-10px);
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.06);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .icon-box {
            width: 64px;
            height: 64px;
            background: var(--accent-glow);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            color: var(--accent);
        }

        /* --- DASHBOARD --- */
        .dashboard {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            border-right: 1px solid var(--glass-border);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sidebar-btn {
            padding: 1rem 1.5rem;
            border-radius: 14px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .sidebar-btn:hover { background: var(--glass); color: var(--text); }
        .sidebar-btn.active { background: var(--accent); color: white; }

        .main-content {
            flex: 1;
            padding: 3rem;
            overflow-y: auto;
        }

        /* --- FORMS & INPUTS --- */
        .input-group { margin-bottom: 1.5rem; }
        .input-group label { display: block; font-size: 0.8rem; font-weight: 700; color: var(--text-dim); margin-bottom: 0.5rem; text-transform: uppercase; }
        input, select, textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            color: white;
            outline: none;
            transition: 0.2s;
        }
        input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-glow); }

        .btn {
            padding: 1rem 2rem;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-ghost { background: transparent; color: var(--text-dim); border: 1px solid var(--glass-border); }

        /* --- EXAM HALL --- */
        .exam-container {
            max-width: 800px;
            margin: 4rem auto;
            padding: 3rem;
        }

        .timer-circle {
            width: 100px;
            height: 100px;
            position: relative;
        }

        .timer-svg { transform: rotate(-90deg); }
        .timer-bg { fill: none; stroke: var(--glass-border); stroke-width: 8; }
        .timer-progress { fill: none; stroke: var(--accent); stroke-width: 8; stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s linear; stroke-linecap: round; }
        .timer-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 800; font-size: 1.2rem; }

        .option-card {
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid var(--glass-border);
        }
        .option-card:hover { border-color: var(--accent); background: var(--glass); }
        .option-card.selected { background: var(--accent); border-color: var(--accent); color: white; }

        /* --- CHART --- */
        .chart-container {
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        /* --- CHAT BOT --- */
        #chatbot-trigger {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        #chatbot-window {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 350px;
            height: 450px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .chat-header { padding: 1.2rem; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .msg { padding: 0.75rem 1rem; border-radius: 12px; max-width: 80%; font-size: 0.9rem; }
        .msg-bot { background: var(--glass); align-self: flex-start; }
        .msg-user { background: var(--accent); align-self: flex-end; }

        /* --- CUSTOM MODAL --- */
        #modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            width: 90%;
            max-width: 450px;
            padding: 3rem;
            text-align: center;
        }

        /* --- STAT CARDS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { padding: 2rem; text-align: center; }
        .stat-card h4 { color: var(--text-dim); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.5rem; }
        .stat-card p { font-size: 2.5rem; font-weight: 800; }

        /* --- TABLE --- */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th { text-align: left; padding: 1rem; color: var(--text-dim); border-bottom: 1px solid var(--glass-border); font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.02); }

        /* --- CERTIFICATE --- */
        #certificate {
            width: 800px;
            height: 600px;
            padding: 40px;
            background: #fff;
            color: #000;
            display: none;
            position: relative;
            border: 20px solid #0f172a;
        }

        .cert-border { border: 5px solid #6366f1; height: 100%; padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }

        @media print {
            body * { visibility: hidden; }
            #certificate, #certificate * { visibility: visible; }
            #certificate { display: block; position: absolute; left: 0; top: 0; margin: 0; }
        }
    </style>

<link rel="stylesheet" href="/index.css">
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "recharts": "https://esm.sh/recharts@^3.6.0"
  }
}
</script>
  <script type="module" crossorigin src="/assets/index-B5Qt9EMX.js"></script>
</head>
<body>

<div id="app">
    <!-- NAVIGATION (SPA VIEWS) -->
    
    <!-- 1. HOME VIEW -->
    <section id="view-home" class="hero animate">
        <h1 class="gradient-text">Ultra Pro Portal</h1>
        <p style="color: var(--text-dim); max-width: 500px;">Precision, security, and intelligence in every examination. Welcome to the elite portal.</p>
        
        <div class="card-grid">
            <div class="portal-card glass" onclick="showView('view-admin-login')">
                <div class="icon-box">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                </div>
                <h3>Admin Portal</h3>
                <p style="font-size: 0.9rem; color: var(--text-dim); margin-top: 0.5rem;">Manage banks and analytics.</p>
            </div>
            <div class="portal-card glass" onclick="showView('view-student-login')">
                <div class="icon-box">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
                </div>
                <h3>Student Portal</h3>
                <p style="font-size: 0.9rem; color: var(--text-dim); margin-top: 0.5rem;">Join exams and get certified.</p>
            </div>
        </div>

        <footer style="margin-top: 4rem; cursor: pointer;" onclick="showView('view-dev')">
            <p style="font-size: 0.75rem; color: var(--text-dim); font-weight: bold; letter-spacing: 0.1em;">DEVELOPED BY AHAMED RAHIM</p>
        </footer>
    </section>

    <!-- 2. ADMIN LOGIN -->
    <section id="view-admin-login" class="hero hidden animate">
        <div class="glass modal-box" style="text-align: left; padding: 3rem;">
            <h2 style="margin-bottom: 2rem;">Admin Access</h2>
            <div class="input-group">
                <label>Master Key</label>
                <input type="password" id="admin-pass" placeholder="••••••••">
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-primary" onclick="loginAdmin()">Login</button>
                <button class="btn btn-ghost" onclick="showView('view-home')">Cancel</button>
            </div>
        </div>
    </section>

    <!-- 3. STUDENT LOGIN -->
    <section id="view-student-login" class="hero hidden animate">
        <div class="glass modal-box" style="text-align: left; padding: 3rem;">
            <h2 style="margin-bottom: 2rem;">Exam Entry</h2>
            <div class="input-group">
                <label>Full Name</label>
                <input type="text" id="student-name" placeholder="John Doe">
            </div>
            <div class="input-group">
                <label>Passkey</label>
                <input type="password" id="student-pass" placeholder="••••">
            </div>
            <div class="input-group">
                <label>Subject</label>
                <select id="exam-subject-select"></select>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-primary" onclick="loginStudent()">Start Exam</button>
                <button class="btn btn-ghost" onclick="showView('view-home')">Cancel</button>
            </div>
        </div>
    </section>

    <!-- 4. ADMIN DASHBOARD -->
    <section id="view-admin-dashboard" class="dashboard hidden animate">
        <aside class="sidebar">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 2rem;">
                <div class="icon-box" style="width: 40px; height: 40px; margin: 0;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
                <h4 style="font-weight: 800;">Admin Panel</h4>
            </div>
            <button class="sidebar-btn active" onclick="switchAdminTab('stats', this)">Stats</button>
            <button class="sidebar-btn" onclick="switchAdminTab('questions', this)">Questions</button>
            <button class="sidebar-btn" onclick="switchAdminTab('results', this)">Results</button>
            <button class="sidebar-btn" style="margin-top: auto; color: var(--error);" onclick="showView('view-home')">Logout</button>
        </aside>
        
        <main class="main-content">
            <div id="tab-stats" class="admin-tab">
                <h1 style="margin-bottom: 2rem;">Performance Overview</h1>
                <div class="stats-grid">
                    <div class="glass stat-card"><h4>Questions</h4><p id="stat-q">0</p></div>
                    <div class="glass stat-card"><h4>Students</h4><p id="stat-s">0</p></div>
                    <div class="glass stat-card"><h4>Avg Pass Rate</h4><p id="stat-p">0%</p></div>
                </div>
                <div class="glass" style="padding: 2rem; text-align: center;">
                    <h3>Pass Distribution</h3>
                    <div id="pie-chart" class="chart-container"></div>
                </div>
            </div>

            <div id="tab-questions" class="admin-tab hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h1>Question Bank</h1>
                    <button class="btn btn-primary" onclick="openQuestionModal()">+ Add Question</button>
                </div>
                <div class="glass" style="overflow-x: auto;">
                    <table id="questions-table">
                        <thead><tr><th>Subject</th><th>Question</th><th>Points</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-results" class="admin-tab hidden">
                <h1 style="margin-bottom: 2rem;">Student Performance</h1>
                <div class="glass">
                    <table id="results-table">
                        <thead><tr><th>Student</th><th>Subject</th><th>Score</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </section>

    <!-- 5. EXAM HALL -->
    <section id="view-exam" class="hidden animate" style="min-height: 100vh;">
        <div class="exam-container glass">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem;">
                <div>
                    <h1 id="exam-subject-title">Mathematics</h1>
                    <p style="color: var(--text-dim); font-size: 0.9rem;" id="exam-q-counter">Question 1 of 10</p>
                </div>
                <div class="timer-circle">
                    <svg class="timer-svg" viewBox="0 0 100 100">
                        <circle class="timer-bg" cx="50" cy="50" r="45"></circle>
                        <circle id="timer-progress" class="timer-progress" cx="50" cy="50" r="45"></circle>
                    </svg>
                    <div id="timer-text" class="timer-text">60</div>
                </div>
            </div>

            <div id="question-area">
                <h2 id="current-q-text" style="margin-bottom: 2rem; line-height: 1.4;"></h2>
                <div id="options-grid"></div>
            </div>

            <div style="margin-top: 3rem; display: flex; justify-content: space-between;">
                <button class="btn btn-ghost" id="btn-prev" onclick="prevQuestion()">Previous</button>
                <button class="btn btn-primary" id="btn-next" onclick="nextQuestion()">Next Question</button>
            </div>
        </div>
    </section>

    <!-- 6. RESULT SUMMARY -->
    <section id="view-result" class="hero hidden animate">
        <div class="glass modal-box" style="max-width: 600px;">
            <div id="result-status-icon" style="margin-bottom: 1.5rem;"></div>
            <h1 id="result-title">Result Summary</h1>
            <p id="result-msg" style="color: var(--text-dim); margin-bottom: 2rem;"></p>
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="glass stat-card"><h4 style="font-size: 0.6rem;">Score</h4><p id="res-score">0</p></div>
                <div class="glass stat-card"><h4 style="font-size: 0.6rem;">Status</h4><p id="res-status" style="font-size: 1.2rem;">FAIL</p></div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-primary" onclick="window.print()">Print Certificate</button>
                <button class="btn btn-ghost" onclick="showView('view-home')">Finish</button>
            </div>
        </div>
    </section>

    <!-- 7. DEVELOPER INFO -->
    <section id="view-dev" class="hero hidden animate">
        <button class="btn btn-ghost" style="margin-bottom: 2rem;" onclick="showView('view-home')">← Back</button>
        <div class="glass" style="max-width: 800px; padding: 4rem; display: flex; gap: 3rem; align-items: center; text-align: left;">
            <div style="width: 250px; height: 250px; border-radius: 40px; overflow: hidden; border: 4px solid var(--glass-border); flex-shrink: 0;">
                <img src="https://i.ibb.co/7DPv5gW/image.png" alt="Ahamed Rahim" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div>
                <h4 style="color: var(--accent); font-weight: 800; letter-spacing: 0.1em; margin-bottom: 0.5rem;">DEVELOPER PROFILE</h4>
                <h1 style="font-size: 3rem; line-height: 1;">Ahamed Rahim</h1>
                <p style="font-weight: 600; font-size: 1.2rem; color: var(--text-dim); margin: 1rem 0;">Full Stack Engineer</p>
                <p style="color: var(--text-dim); line-height: 1.6; margin-bottom: 2rem;">Passionate developer and architectural enthusiast. Creator of Ultra-Pro Exam Portal, focused on high-performance digital solutions.</p>
                <a href="https://ahamed-pages.dev/" target="_blank" class="btn btn-primary">Visit Website</a>
            </div>
        </div>
    </section>
</div>

<!-- CHATBOT -->
<div id="chatbot-trigger"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2m16 0h2m-7-1v2m-6-2v2"/></svg></div>
<div id="chatbot-window" class="glass hidden animate">
    <div class="chat-header">
        <span style="font-weight: 800; font-size: 0.8rem;">Ultra Study AI</span>
        <span style="cursor: pointer;" onclick="toggleChat()">✕</span>
    </div>
    <div class="chat-messages" id="chat-msgs">
        <div class="msg msg-bot">Hello! I am your AI assistant. How can I help you today?</div>
    </div>
    <div style="padding: 1rem; border-top: 1px solid var(--glass-border); display: flex; gap: 0.5rem;">
        <input type="text" id="chat-input" placeholder="Type a question..." style="padding: 0.5rem 1rem; border-radius: 10px;">
        <button class="btn btn-primary" style="padding: 0.5rem 1rem;" onclick="sendMessage()">➤</button>
    </div>
</div>

<!-- MODALS -->
<div id="modal-overlay" class="hidden">
    <div class="glass modal-box animate" id="custom-modal-content"></div>
</div>

<!-- CERTIFICATE TEMPLATE -->
<div id="certificate">
    <div class="cert-border">
        <p style="font-size: 1.5rem; letter-spacing: 0.2em;">CERTIFICATE OF EXCELLENCE</p>
        <p style="margin: 2rem 0; font-size: 1rem;">This is to certify that</p>
        <h1 id="cert-name" style="font-size: 3.5rem; font-family: serif; border-bottom: 2px solid #000; padding-bottom: 10px;">NAME HERE</h1>
        <p style="margin: 2rem 0; font-size: 1rem;">has successfully qualified the examination in</p>
        <h2 id="cert-subject" style="font-size: 2rem; color: #6366f1;">SUBJECT HERE</h2>
        <div style="margin-top: 3rem; width: 100%; display: flex; justify-content: space-around;">
            <div>
                <p style="font-weight: bold; border-top: 1px solid #000; padding-top: 5px;" id="cert-date">2024-01-01</p>
                <p style="font-size: 0.7rem;">DATE</p>
            </div>
            <div>
                <p style="font-weight: bold; border-top: 1px solid #000; padding-top: 5px; font-style: italic;">Ahamed Rahim</p>
                <p style="font-size: 0.7rem;">SYSTEM DIRECTOR</p>
            </div>
        </div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let state = {
        view: 'view-home',
        questions: JSON.parse(localStorage.getItem('up_questions')) || [],
        results: JSON.parse(localStorage.getItem('up_results')) || [],
        activeTab: 'stats',
        currentUser: null,
        currentExam: {
            questions: [],
            answers: {},
            index: 0,
            timer: 60,
            interval: null
        }
    };

    function saveData() {
        localStorage.setItem('up_questions', JSON.stringify(state.questions));
        localStorage.setItem('up_results', JSON.stringify(state.results));
    }

    // --- NAVIGATION ---
    function showView(viewId) {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');
        state.view = viewId;

        if(viewId === 'view-admin-dashboard') updateAdminDashboard();
        if(viewId === 'view-student-login') populateSubjectSelect();
        
        // Fullscreen Logic
        if(viewId === 'view-exam') {
            document.documentElement.requestFullscreen().catch(() => {});
        } else if (document.fullscreenElement) {
            document.exitFullscreen().catch(() => {});
        }
    }

    // --- AUTH ---
    function loginAdmin() {
        const pass = document.getElementById('admin-pass').value;
        if(pass === 'admin') {
            showView('view-admin-dashboard');
            document.getElementById('admin-pass').value = '';
        } else {
            customAlert("Invalid Access Key", "error");
        }
    }

    function loginStudent() {
        const name = document.getElementById('student-name').value;
        const pass = document.getElementById('student-pass').value;
        const subject = document.getElementById('exam-subject-select').value;

        if(!name || pass !== '1234' || !subject) {
            customAlert("Invalid credentials or missing subject", "error");
            return;
        }

        const filtered = state.questions.filter(q => q.subject === subject);
        if(filtered.length === 0) {
            customAlert("No questions available for this subject", "error");
            return;
        }

        state.currentUser = { name, subject };
        state.currentExam.questions = filtered;
        state.currentExam.index = 0;
        state.currentExam.answers = {};
        state.currentExam.timer = filtered.length * 60;
        showView('view-exam');
        startExam();
    }

    function populateSubjectSelect() {
        const select = document.getElementById('exam-subject-select');
        const subjects = [...new Set(state.questions.map(q => q.subject))];
        select.innerHTML = subjects.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    // --- ADMIN DASHBOARD ---
    function switchAdminTab(tabId, btn) {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        btn.classList.add('active');
        state.activeTab = tabId;
        updateAdminDashboard();
    }

    function updateAdminDashboard() {
        document.getElementById('stat-q').textContent = state.questions.length;
        document.getElementById('stat-s').textContent = state.results.length;
        
        const passedCount = state.results.filter(r => r.passed).length;
        const rate = state.results.length ? Math.round((passedCount / state.results.length) * 100) : 0;
        document.getElementById('stat-p').textContent = rate + '%';

        renderPieChart(passedCount, state.results.length - passedCount);
        renderQuestionsTable();
        renderResultsTable();
    }

    function renderQuestionsTable() {
        const tbody = document.querySelector('#questions-table tbody');
        tbody.innerHTML = state.questions.map(q => `
            <tr>
                <td><b>${q.subject}</b></td>
                <td>${q.text.substring(0, 40)}...</td>
                <td>${q.points}</td>
                <td>
                    <button class="btn btn-ghost" style="padding: 0.5rem;" onclick="deleteQuestion('${q.id}')">Delete</button>
                </td>
            </tr>
        `).join('');
    }

    function renderResultsTable() {
        const tbody = document.querySelector('#results-table tbody');
        tbody.innerHTML = state.results.map(r => `
            <tr>
                <td>${r.studentName}</td>
                <td>${r.subject}</td>
                <td>${r.score}/${r.total}</td>
                <td><span style="color: ${r.passed ? 'var(--success)' : 'var(--error)'}">${r.passed ? 'PASS' : 'FAIL'}</span></td>
            </tr>
        `).join('');
    }

    function openQuestionModal() {
        const modal = document.getElementById('custom-modal-content');
        modal.innerHTML = `
            <h2 style="margin-bottom: 2rem;">Add Question</h2>
            <div class="input-group"><label>Subject</label><input type="text" id="q-sub"></div>
            <div class="input-group"><label>Question Text</label><textarea id="q-txt" rows="3"></textarea></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <input type="text" id="q-o1" placeholder="Option 1">
                <input type="text" id="q-o2" placeholder="Option 2">
                <input type="text" id="q-o3" placeholder="Option 3">
                <input type="text" id="q-o4" placeholder="Option 4">
            </div>
            <div class="input-group" style="margin-top: 1rem;"><label>Correct Index (1-4)</label><input type="number" id="q-correct" min="1" max="4"></div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="saveNewQuestion()">Save</button>
                <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            </div>
        `;
        openModal();
    }

    function saveNewQuestion() {
        const q = {
            id: Date.now().toString(),
            subject: document.getElementById('q-sub').value,
            text: document.getElementById('q-txt').value,
            options: [
                document.getElementById('q-o1').value,
                document.getElementById('q-o2').value,
                document.getElementById('q-o3').value,
                document.getElementById('q-o4').value
            ],
            correct: parseInt(document.getElementById('q-correct').value) - 1,
            points: 1
        };
        state.questions.push(q);
        saveData();
        closeModal();
        updateAdminDashboard();
    }

    function deleteQuestion(id) {
        state.questions = state.questions.filter(q => q.id !== id);
        saveData();
        updateAdminDashboard();
    }

    // --- EXAM LOGIC ---
    function startExam() {
        renderQuestion();
        if(state.currentExam.interval) clearInterval(state.currentExam.interval);
        state.currentExam.interval = setInterval(() => {
            state.currentExam.timer--;
            updateTimerUI();
            if(state.currentExam.timer <= 0) finishExam();
        }, 1000);
    }

    function updateTimerUI() {
        const text = document.getElementById('timer-text');
        const progress = document.getElementById('timer-progress');
        const total = state.currentExam.questions.length * 60;
        const pct = (state.currentExam.timer / total) * 283;
        
        text.textContent = Math.max(0, state.currentExam.timer);
        progress.style.strokeDashoffset = 283 - pct;
        if(state.currentExam.timer < 10) text.style.color = 'var(--error)';
    }

    function renderQuestion() {
        const q = state.currentExam.questions[state.currentExam.index];
        document.getElementById('exam-subject-title').textContent = q.subject;
        document.getElementById('exam-q-counter').textContent = `Question ${state.currentExam.index + 1} of ${state.currentExam.questions.length}`;
        document.getElementById('current-q-text').textContent = q.text;
        
        const grid = document.getElementById('options-grid');
        grid.innerHTML = q.options.map((opt, i) => `
            <div class="glass option-card ${state.currentExam.answers[q.id] === i ? 'selected' : ''}" onclick="selectOption('${q.id}', ${i})">
                ${opt}
            </div>
        `).join('');

        document.getElementById('btn-prev').disabled = state.currentExam.index === 0;
        document.getElementById('btn-next').textContent = state.currentExam.index === state.currentExam.questions.length - 1 ? 'Finish Exam' : 'Next Question';
    }

    function selectOption(qid, idx) {
        state.currentExam.answers[qid] = idx;
        renderQuestion();
    }

    function nextQuestion() {
        if(state.currentExam.index < state.currentExam.questions.length - 1) {
            state.currentExam.index++;
            renderQuestion();
        } else {
            finishExam();
        }
    }

    function prevQuestion() {
        if(state.currentExam.index > 0) {
            state.currentExam.index--;
            renderQuestion();
        }
    }

    function finishExam() {
        clearInterval(state.currentExam.interval);
        let score = 0;
        state.currentExam.questions.forEach(q => {
            if(state.currentExam.answers[q.id] === q.correct) score += q.points;
        });

        const total = state.currentExam.questions.length;
        const passed = score / total >= 0.4;
        
        const res = {
            id: Date.now().toString(),
            studentName: state.currentUser.name,
            subject: state.currentUser.subject,
            score,
            total,
            passed,
            date: new Date().toLocaleDateString()
        };

        state.results.push(res);
        saveData();

        // UI Update
        document.getElementById('res-score').textContent = `${score}/${total}`;
        document.getElementById('res-status').textContent = passed ? 'PASS' : 'FAIL';
        document.getElementById('res-status').style.color = passed ? 'var(--success)' : 'var(--error)';
        document.getElementById('result-msg').textContent = passed ? "Excellent work! You have proven your mastery." : "You did not meet the criteria. Try again after review.";
        
        document.getElementById('cert-name').textContent = res.studentName.toUpperCase();
        document.getElementById('cert-subject').textContent = res.subject.toUpperCase();
        document.getElementById('cert-date').textContent = res.date;

        showView('view-result');
    }

    // --- CHART GENERATOR (PURE SVG) ---
    function renderPieChart(pass, fail) {
        const total = pass + fail;
        const container = document.getElementById('pie-chart');
        if(total === 0) {
            container.innerHTML = '<p style="margin-top: 80px; opacity: 0.5;">No Data</p>';
            return;
        }
        
        const passPct = (pass / total) * 100;
        const failPct = (fail / total) * 100;
        const passDeg = (passPct / 100) * 360;

        const x = Math.cos(2 * Math.PI * (passPct / 100));
        const y = Math.sin(2 * Math.PI * (passPct / 100));
        const largeArc = passPct > 50 ? 1 : 0;

        container.innerHTML = `
            <svg viewBox="-1 -1 2 2" style="transform: rotate(-90deg); width: 100%; height: 100%;">
                <circle r="1" cx="0" cy="0" fill="var(--glass-border)" />
                <path d="M 1 0 A 1 1 0 ${largeArc} 1 ${x} ${y} L 0 0" fill="var(--accent)" />
            </svg>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem; font-size: 0.8rem;">
                <span><i style="background: var(--accent); width: 10px; height: 10px; display: inline-block;"></i> Pass: ${Math.round(passPct)}%</span>
                <span><i style="background: var(--glass-border); width: 10px; height: 10px; display: inline-block;"></i> Fail: ${Math.round(failPct)}%</span>
            </div>
        `;
    }

    // --- AI CHATBOT MOCK ---
    function toggleChat() {
        document.getElementById('chatbot-window').classList.toggle('hidden');
    }
    document.getElementById('chatbot-trigger').onclick = toggleChat;

    function sendMessage() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if(!text) return;

        const box = document.getElementById('chat-msgs');
        box.innerHTML += `<div class="msg msg-user animate">${text}</div>`;
        input.value = '';
        box.scrollTop = box.scrollHeight;

        setTimeout(() => {
            const replies = [
                "The Ultra Pro system is designed for high-security academic assessments.",
                "To pass, you generally need to score at least 40% correctly.",
                "You can manage questions in the Admin Bank using the 'admin' key.",
                "Don't worry, even if you fail, excellence is a journey!",
                "I am monitoring your performance. Stay focused."
            ];
            const reply = replies[Math.floor(Math.random() * replies.length)];
            box.innerHTML += `<div class="msg msg-bot animate">${reply}</div>`;
            box.scrollTop = box.scrollHeight;
        }, 800);
    }

    // --- MODAL UTILS ---
    function openModal() { document.getElementById('modal-overlay').classList.remove('hidden'); }
    function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
    function customAlert(msg, type) {
        const modal = document.getElementById('custom-modal-content');
        modal.innerHTML = `
            <div class="icon-box" style="margin: 0 auto 1.5rem; background: ${type==='error'?'var(--error)':'var(--accent)'}; color: white;">
                ${type==='error' ? '✕' : '✓'}
            </div>
            <h2>${type==='error' ? 'Oops!' : 'Notification'}</h2>
            <p style="color: var(--text-dim); margin: 1rem 0 2rem;">${msg}</p>
            <button class="btn btn-primary" onclick="closeModal()">Dismiss</button>
        `;
        openModal();
    }

    // Initial View
    showView('view-home');
</script>

</body>
</html>